<!DOCTYPE html>
<html>
<head>
    <title>–¢–∏–∫–µ—Ç #{{ ticket.id }}</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0;
            background: #f0f2f5;
        }
        .header { 
            background: white; 
            padding: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .nav a { 
            margin-right: 20px; 
            text-decoration: none; 
            color: #007cba;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 4px;
        }
        .nav a:hover {
            background: #f0f8ff;
        }
        .ticket-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .media-gallery {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .conversation {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .message-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .media-item {
            display: inline-block;
            margin: 10px;
            vertical-align: top;
        }
        .media-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .message-admin {
            background: #e3f2fd;
            margin-left: 50px;
        }
        .message-user {
            background: #f5f5f5;
            margin-right: 50px;
        }
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #005a87;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .status-open { background: #ffe6e6; color: #dc3545; }
        .status-in_progress { background: #fff3cd; color: #856404; }
        .status-resolved { background: #e6f4ea; color: #28a745; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üé´ –¢–∏–∫–µ—Ç #{{ ticket.id }} - {{ ticket.first_name }}</h1>
            <div class="nav">
                <a href="/dashboard">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="/tickets">üé´ –í—Å–µ —Ç–∏–∫–µ—Ç—ã</a>
                <a href="/logout">üö™ –í—ã–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ -->
        <div class="ticket-info">
            <h2>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ</h2>
            <p><strong>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ ticket.first_name }} ({{ ticket.username or 'N/A' }})</p>
            <p><strong>üÜî User ID:</strong> {{ ticket.user_id }}</p>
            <p><strong>üìù –¢–∏–ø:</strong> 
                {% if ticket.ticket_type == 'manager_request' %}üë®‚Äçüíº –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
                {% elif ticket.ticket_type == 'violation_report' %}‚ö†Ô∏è –û—Ç—á–µ—Ç –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏
                {% else %}{{ ticket.ticket_type }}
                {% endif %}
            </p>
            <p><strong>üìÑ –û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ ticket.description }}</p>
            <p><strong>üïí –°–æ–∑–¥–∞–Ω:</strong> {{ ticket.created_at }}</p>
            <p><strong>üìä –°—Ç–∞—Ç—É—Å:</strong> 
                <span class="status-badge status-{{ ticket.status }}">
                    {% if ticket.status == 'open' %}‚ö†Ô∏è –û—Ç–∫—Ä—ã—Ç
                    {% elif ticket.status == 'in_progress' %}üîÑ –í —Ä–∞–±–æ—Ç–µ
                    {% elif ticket.status == 'resolved' %}‚úÖ –†–µ—à–µ–Ω
                    {% else %}{{ ticket.status }}
                    {% endif %}
                </span>
            </p>
            
            <div class="ticket-actions">
                <h3>–î–µ–π—Å—Ç–≤–∏—è —Å —Ç–∏–∫–µ—Ç–æ–º:</h3>
                {% if ticket.status != 'resolved' %}
                <button onclick="updateTicketStatus('resolved')">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å —Ä–µ—à–µ–Ω–Ω—ã–º</button>
                {% endif %}
                {% if ticket.status != 'in_progress' %}
                <button onclick="updateTicketStatus('in_progress')">üîÑ –í —Ä–∞–±–æ—Ç—É</button>
                {% endif %}
                {% if ticket.status != 'open' %}
                <button onclick="updateTicketStatus('open')">‚ö†Ô∏è –û—Ç–∫—Ä—ã—Ç—å —Å–Ω–æ–≤–∞</button>
                {% endif %}
            </div>
        </div>

        <!-- –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã -->
        {% if media_files %}
        <div class="media-gallery">
            <h2>üì∏ –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h2>
            {% for media in media_files %}
            <div class="media-item">
                {% if media.file_type == 'photo' %}
                <a href="/media/{{ media.file_path }}" target="_blank">
                    <img src="/media/{{ media.file_path }}" alt="–§–æ—Ç–æ" class="media-image">
                </a>
                {% elif media.file_type == 'video' %}
                <video controls width="300" class="media-image">
                    <source src="/media/{{ media.file_path }}" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                </video>
                {% else %}
                <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <strong>üìé –§–∞–π–ª:</strong> {{ media.file_path }}<br>
                    <a href="/media/{{ media.file_path }}" target="_blank">–°–∫–∞—á–∞—Ç—å</a>
                </div>
                {% endif %}
                {% if media.caption %}
                <p><small>{{ media.caption }}</small></p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ -->
        <div class="conversation">
            <h2>üí¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏</h2>
            <div id="conversation-container">
                {% for message in conversation %}
                <div class="message {% if message.is_from_admin %}message-admin{% else %}message-user{% endif %}">
                    <div class="message-sender">
                        {% if message.is_from_admin %}üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% else %}üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å{% endif %}
                        <small>{{ message.timestamp }}</small>
                    </div>
                    <div>{{ message.message_text }}</div>
                </div>
                {% else %}
                <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                {% endfor %}
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="message-form">
            <h2>‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
            <textarea id="message-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <br>
            <button onclick="sendMessage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            <div id="message-result" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
    function updateTicketStatus(status) {
        if (confirm('–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞?')) {
            fetch('/api/tickets/{{ ticket.id }}', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                }
            });
        }
    }

    function sendMessage() {
        const messageText = document.getElementById('message-text').value.trim();
        const resultDiv = document.getElementById('message-result');
        
        if (!messageText) {
            resultDiv.innerHTML = '<span style="color: red;">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</span>';
            return;
        }

        fetch('/api/ticket/{{ ticket.id }}/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = '<span style="color: green;">‚úÖ ' + data.message + '</span>';
                document.getElementById('message-text').value = '';
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏
                loadConversation();
            } else {
                resultDiv.innerHTML = '<span style="color: red;">‚ùå ' + data.error + '</span>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<span style="color: red;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error + '</span>';
        });
    }

    function loadConversation() {
        fetch('/api/ticket/{{ ticket.id }}/conversation')
        .then(response => response.json())
        .then(messages => {
            const container = document.getElementById('conversation-container');
            container.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.is_from_admin ? 'message-admin' : 'message-user'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-sender">
                        ${message.is_from_admin ? 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                        <small>${message.timestamp}</small>
                    </div>
                    <div>${message.message_text}</div>
                `;
                
                container.appendChild(messageDiv);
            });
        });
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setInterval(loadConversation, 10000);

    // –í —Å–µ–∫—Ü–∏–∏ <script> –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    function sendMessage() {
        const messageText = document.getElementById('message-text').value.trim();
        const resultDiv = document.getElementById('message-result');
        
        if (!messageText) {
            resultDiv.innerHTML = '<span style="color: red;">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</span>';
            return;
        }
    
        console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–∏–∫–µ—Ç–∞ {{ ticket.id }}, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ ticket.user_id }}`);
    
        fetch('/api/ticket/{{ ticket.id }}/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageText })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json().then(data => {
                return { ok: response.ok, data: data };
            });
        })
        .then(({ ok, data }) => {
            console.log('Response data:', data);
            if (ok && data.success) {
                resultDiv.innerHTML = '<span style="color: green;">‚úÖ ' + data.message + '</span>';
                document.getElementById('message-text').value = '';
                loadConversation();
            } else {
                resultDiv.innerHTML = '<span style="color: red;">‚ùå ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</span>';
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resultDiv.innerHTML = '<span style="color: red;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error + '</span>';
        });
    }
    </script>
</body>
</html>
